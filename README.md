基本概念
========

本网关不是一个通用型的网关，它有一套自己的通讯协议，需要配套的客户端和服务端才能使用。

本网关的设计目的有以下几点：

1. 复用客户端网络连接
2. 减少暴露在公网的服务器
3. 提升网络故障转移的效率

网关采用的是被动式的设计，需要客户端和服务端主动连接到网关。

客户端和网关之间，以及服务端跟网关之间，都只会建立一个物理连接。

![Gateway](https://raw.githubusercontent.com/fastgo/gateway/master/gateway.png)

虚拟连接
========

因为客户端到网关只有一个物理连接，但业务场景中往往需要客户端跟多个服务端进行通讯。

并且从服务端的角度，用一个物理连接和网关通讯，需要能从这个物理连接传输过来的数据中分辨出数据属于哪个客户端连接。

所以需要在通讯协议层面构建虚拟连接概念。

虚拟连接的实现逻辑：

+ 每个客户端都各自维护一个自增的虚拟连接ID。
+ 客户端向目标服务端发送消息时，将`服务端ID`和`虚拟连接ID`附加在包头发送给网关。
+ 网关通过识别包头的`服务端ID`来找到对应的物理连接，并将`客户端ID`和`虚拟连接ID`附加在包头发送给服务端。
+ 服务端通过`网关ID` + `客户端ID` + `虚拟连接ID`来取到对应的虚拟连接。
+ 当服务端对客户端发送消息时，将`客户端ID`和`虚拟连接ID`附加在包头发送给网关。
+ 网关通过识别包头的`客户端ID`来找到对应的客户端物理连接，并将`服务端ID`和`虚拟连接ID`附加在消息的包头发送给服务端。
+ 客户端通过包头`虚拟连接ID`来渠道对应的虚拟连接。

客户端协议
==========

上下行格式：

```
+------------------------+--------------------+------------------+---------+
| Packet Length (4 byte) | Server ID (4 byte) | Conn ID (2 byte) | Message |
+------------------------+--------------------+------------------+---------+
```

特殊约定：

+ `Packet Length` = 4 (`Server ID`) + 2 (`Conn ID`) + len(`Message`)
+ `Packet Length = 6`的消息用来关闭虚拟连接。
+ `Server ID = max(uint32)`并且`Conn ID = 0`的消息用来进行存活检查，客户端收到此消息后应该立即回应。

服务端端协议
============

服务端在连接网关时，如果时新建连接，需要执行额外握手协议来验证服务端的合法性。

握手过程：

0. 合法的服务端应持有正确的网关秘钥。
1. 网关在接受到新的服务端连接之后，向新连接发送一个`uint64`范围内的随机数作为挑战码。
2. 服务端收到挑战码后，拿出秘钥，计算 `MD5(挑战码 + 秘钥)`，得到验证码。
3. 服务端将验证码和自身节点ID一起发送给网关。
4. 网关收到消息后同样计算 `MD5(挑战码 + 秘钥)`，跟收到的验证码比对是否一致。
5. 验证码比对一致，网关将新连接登记为对应节点ID的连接。

握手下行格式：

```
+-------------------------+
| Challenge Code (8 byte) |
+-------------------------+
```

握手上行格式：

```
+---------------+--------------------+
| MD5 (16 byte) | Server ID (4 byte) |
+---------------+--------------------+
```

上下行格式：

```
+------------------------+--------------------+------------------+---------+
| Packet Length (4 byte) | Client ID (4 byte) | Conn ID (2 byte) | Message |
+------------------------+--------------------+------------------+---------+
```

特殊约定：

+ `Packet Length` = 4 (`Client ID`) + 2 (`Conn ID`) + len(`Message`)
+ `Packet Length = 6`的消息用来关闭虚拟连接。
+ `Client ID = max(uint32)`并且`Conn ID = 0`的消息用来进行存活检查，服务端收到此消息后应该立即回应相同的消息。
