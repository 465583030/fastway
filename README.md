
前端协议
=======

上下行：

```
+----------------+------------------+---------+
| 消息长度 (4字节) | 后端节点ID (8字节) | 消息内容 |
+----------------+------------------+---------+
```

特殊约定：

1. 客户端发送`节点ID = N, 消息长度 = 0`的消息，用来显式关闭跟指定后端之间端虚拟连接
2. 网关发送`节点ID = N, 消息长度 = 0`的消息，用来告知客户端某个**使用过的**后端节点失效
3. 网关之发送`节点ID = MAX(uint64), 消息长度 = 0`的消息，用来进行检查客户端连接是否存活
4. 客户端发送`节点ID = MAX(uint64), 消息长度 = 0`的消息，用来回应网关的检查


后端协议
=======

上下行：

```
+----------------+----------------+---------+
| 消息类型 (1字节) | 消息长度 (4字节) | 消息内容 |
+----------------+----------------+---------+
```

消息类型和对应消息内容格式：

0. 发送给指定客户端

	```
	+--------------------+--------+
	| 客户端连接ID (8字节) | 消息内容 |
	+--------------------+--------+
	```

1. 断开指定客户端

	```
	+--------------------+
	| 客户端连接ID (8字节) |
	+--------------------+
	```

2. PING / PONG

优化细节
=======

网关为每个客户端连接分配一个`Receive Buffer`，只有当`Receive Buffer`容量不足以装下将要读取的消息时才会重新申请内存。

对于同一个客户端，网关每次只为其转发一个消息，消息还没转发成功时不会读取后续消息，所以`Receive Buffer`是被顺序使用的，并且可以被重复使用。

协议设计时有意的对齐前端上行消息和后端上行消息格式，后端上行消息只多了头部一个字节的消息类型字段：

```
                           +----------------+------------------+---------+
前端上行:                   | 消息长度 (4字节) | 后端节点ID (8字节) | 消息内容 |
                           +----------------+------------------+---------+

          +----------------+----------------+------------------+---------+
后端上行:  | 消息类型 (1字节) | 消息长度 (4字节) |  客户端ID (8字节)  | 消息内容 |
          +----------------+----------------+------------------+---------+
```

在读取前端上行消息时，在`Receive Buffer`头部预留一个字节，读取完整前端消息后，将`Receive Buffer`中的`后端ID`填充为`客户端ID`，就可以直接作为后端上行消息转发出去，不需要再多一次数据拷贝。